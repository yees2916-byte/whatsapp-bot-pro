from flask import Flask, request
import google.generativeai as genai
import os
from twilio.twiml.messaging_response import MessagingResponse

app = Flask(__name__)

# ุฅุนุฏุงุฏ ุงูููุชุงุญ
genai.configure(api_key=os.environ.get("GEMINI_API_KEY"))

# ุฅุนุฏุงุฏ ุงูููุฏูู "ุงููุฑูู" (1.5 Flash) ูุถูุงู ุนุฏู ุชููู ุงูุจูุช
model = genai.GenerativeModel('gemini-1.5-flash')

@app.route("/bot", methods=['POST'])
def bot():
    # ุชูุธูู ุงูุฑุณุงูุฉ ุงููุงุฏูุฉ
    user_msg = request.values.get('Body', '').strip().lower()
    resp = MessagingResponse()
    
    # ูุงุฆูุฉ ุงููููุงุช ุงูุชู ุชุณุชุฏุนู ุฑุณุงูุฉ ุงูุชุฑุญูุจ
    greetings = ['ุณูุงู', 'ูุฑุญุจุง', 'ูุฑุญุจุงู', 'ุฃููุง', 'ููุง', 'hi', 'hello', 'start', 'ุจุงุณู ุงููู']
    
    # 1. ุงูุชุญูู: ูู ุงูุฑุณุงูุฉ ุชุญูุฉุ
    # ุฅุฐุง ูุงูุช ุชุญูุฉุ ูุฑุณู ุงูุชุนุฑูู ุจุงููุงูุฏ ููุฑุงู ุฏูู ุงุณุชููุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    if any(greet in user_msg for greet in greetings):
        welcome_text = (
            "ูุฑุญุจุงู ุจู. ุฃูุง ุงููุณุงุนุฏ ุงูุฐูู ููุฃุณุชุงุฐ *ุนุงูู ุนุจุฏ ุงููู*. \n\n"
            "ุฃุชุดุฑู ุจุฎุฏูุชู ูู ุฑุญุงุจ ูุฐุง ุงูุนูู ุงูุฐู ุฃูุฏุงู ุตุงุญุจู ุตุฏูุฉ ุฌุงุฑูุฉ ุนู ุฑูุญ ูุงูุฏู: \n"
            "โจ *ุงููุฌุงูุฏ ุญุงูุธ ุงููุฑุขู ุงููุฑููุ ูุฅูุงู ูุณุฌุฏ ุจูุฏูุฉ ุชูุฑุณูู ุจููุงูุฉ ุณุนูุฏุฉุ ุงูููู ุงูุตุงูุญ 'ุนุงูู ุงูุญุงุฌ ุงูููู'* โจ\n"
            "(ุฑุญูู ุงููู ูุฃุณููู ูุณูุญ ุฌูุงุชู). \n\n"
            "๐ก ุชูุถู ุจุทุฑุญ ุณุคุงูู ูู ุฃู ูุฌุงูุ ูุฃูุง ูู ุงูุฎุฏูุฉ."
        )
        resp.message(welcome_text)
        return str(resp)

    # 2. ุฅุฐุง ูู ุชูู ุชุญูุฉุ ุฃุฑุณููุง ููุฐูุงุก ุงูุงุตุทูุงุนู ููุฅุฌุงุจุฉ
    try:
        # ุฅุฑุณุงู ุงูุณุคุงู ูุฌูุฌู
        ai_response = model.generate_content(user_msg)
        
        # ุงูุฑุฏ ุจุงูุฅุฌุงุจุฉ
        resp.message(ai_response.text)
        
    except Exception as e:
        # ูู ุญุงู ุญุฏูุซ ุฃู ุฎุทุฃ
        resp.message("โ๏ธ ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู ุจุณูุท. ูุฑุฌู ุฅุนุงุฏุฉ ุงููุญุงููุฉ.")
        print(f"Error: {e}")
    
    return str(resp)

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=10000)
